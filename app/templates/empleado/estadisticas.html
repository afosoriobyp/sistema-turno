{% extends "base.html" %}

{% block title %}Estad√≠sticas - Empleados{% endblock %}

{% block content %}
<!-- Incluir Sidebar -->
{% include 'components/sidebar.html' %}

<div class="main-content-with-sidebar">
<div class="estadisticas-container">
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            <h1>üìà Estad√≠sticas de Atenci√≥n</h1>
        </div>
        <div class="navbar-menu">
            <a href="{{ url_for('empleado.dashboard') }}" class="btn btn-outline">
                ‚Üê Volver al Dashboard
            </a>
            <a href="{{ url_for('empleado.logout') }}" class="btn btn-outline">
                üö™ Cerrar Sesi√≥n
            </a>
        </div>
    </nav>
    
    <!-- Filtros de fecha -->
    <div class="filtros-card">
        <h2>Filtros de Consulta</h2>
        <form id="formFiltros" onsubmit="return consultarEstadisticas(event)">
            <div class="filtros-grid">
                <div class="form-group">
                    <label for="fechaInicio">Fecha Inicio:</label>
                    <input type="date" id="fechaInicio" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="fechaFin">Fecha Fin:</label>
                    <input type="date" id="fechaFin" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">
                        üîç Consultar
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Resultados -->
    <div id="resultados" style="display: none;">
        <!-- Resumen general -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üìä</div>
                <div class="stat-info">
                    <h3 id="totalTurnos">0</h3>
                    <p>Total de Turnos</p>
                </div>
            </div>
            
            <div class="stat-card stat-success">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-info">
                    <h3 id="turnosAtendidos">0</h3>
                    <p>Atendidos</p>
                </div>
            </div>
            
            <div class="stat-card stat-warning">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-info">
                    <h3 id="turnosPendientes">0</h3>
                    <p>Pendientes</p>
                </div>
            </div>
            
            <div class="stat-card stat-info">
                <div class="stat-icon">‚è±Ô∏è</div>
                <div class="stat-info">
                    <h3 id="tiempoPromedio">0</h3>
                    <p>Tiempo Promedio (min)</p>
                </div>
            </div>
        </div>
        
        <!-- Gr√°ficos y detalles -->
        <div class="estadisticas-grid">
            <!-- Turnos por estado -->
            <div class="estadistica-card">
                <h3>Turnos por Estado</h3>
                <div class="chart-container">
                    <canvas id="chartEstados"></canvas>
                </div>
                <div id="listaEstados" class="stats-list"></div>
            </div>
            
            <!-- Turnos por categor√≠a -->
            <div class="estadistica-card">
                <h3>Turnos por Categor√≠a de Atenci√≥n</h3>
                <div class="chart-container">
                    <canvas id="chartCategorias"></canvas>
                </div>
                <div id="listaCategorias" class="stats-list"></div>
            </div>
        </div>
        
        <!-- Turnos por tipo de tr√°mite -->
        <div class="estadistica-card-full">
            <h3>Turnos por Tipo de Tr√°mite</h3>
            <div class="chart-container-large">
                <canvas id="chartTramites"></canvas>
            </div>
            <div id="listaTramites" class="stats-list"></div>
        </div>
        
        <!-- Bot√≥n para exportar -->
        <div class="export-section">
            <button onclick="exportarPDF()" class="btn btn-secondary">
                üìÑ Exportar a PDF
            </button>
            <button onclick="exportarExcel()" class="btn btn-secondary">
                üìä Exportar a Excel
            </button>
        </div>
    </div>
    
    <!-- Mensaje cuando no hay datos -->
    <div id="sinDatos" class="no-data" style="display: none;">
        <p>Seleccione un rango de fechas para consultar las estad√≠sticas</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    let datosEstadisticas = null;
    let charts = {
        estados: null,
        categorias: null,
        tramites: null
    };
    
    /**
     * Establece las fechas por defecto (√∫ltimo mes)
     */
    window.onload = function() {
        const hoy = new Date();
        const hace30dias = new Date();
        hace30dias.setDate(hoy.getDate() - 30);
        
        document.getElementById('fechaFin').valueAsDate = hoy;
        document.getElementById('fechaInicio').valueAsDate = hace30dias;
    };
    
    /**
     * Consulta las estad√≠sticas seg√∫n el rango de fechas
     */
    async function consultarEstadisticas(event) {
        event.preventDefault();
        
        const fechaInicio = document.getElementById('fechaInicio').value;
        const fechaFin = document.getElementById('fechaFin').value;
        
        if (!fechaInicio || !fechaFin) {
            alert('Por favor seleccione ambas fechas');
            return false;
        }
        
        try {
            const response = await fetch('{{ url_for("empleado.obtener_estadisticas") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    fecha_inicio: fechaInicio,
                    fecha_fin: fechaFin
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                datosEstadisticas = data;
                mostrarEstadisticas(data);
            } else {
                alert(data.error || 'Error al consultar estad√≠sticas');
            }
        } catch (error) {
            alert('Error de conexi√≥n');
            console.error(error);
        }
        
        return false;
    }
    
    /**
     * Muestra las estad√≠sticas en la interfaz
     */
    function mostrarEstadisticas(data) {
        // Mostrar secci√≥n de resultados
        document.getElementById('resultados').style.display = 'block';
        document.getElementById('sinDatos').style.display = 'none';
        
        // Actualizar valores generales
        document.getElementById('totalTurnos').textContent = data.total_turnos;
        document.getElementById('turnosAtendidos').textContent = data.turnos_por_estado.atendido;
        document.getElementById('turnosPendientes').textContent = data.turnos_por_estado.pendiente;
        document.getElementById('tiempoPromedio').textContent = data.tiempo_promedio_atencion;
        
        // Crear gr√°ficos
        crearGraficoEstados(data.turnos_por_estado);
        crearGraficoCategorias(data.turnos_por_categoria);
        crearGraficoTramites(data.turnos_por_tramite);
        
        // Crear listas detalladas
        crearListaEstados(data.turnos_por_estado);
        crearListaCategorias(data.turnos_por_categoria);
        crearListaTramites(data.turnos_por_tramite);
    }
    
    /**
     * Crea el gr√°fico de turnos por estado
     */
    function crearGraficoEstados(datos) {
        const ctx = document.getElementById('chartEstados').getContext('2d');
        
        // Destruir gr√°fico anterior si existe
        if (charts.estados) {
            charts.estados.destroy();
        }
        
        charts.estados = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Atendidos', 'Pendientes', 'En Atenci√≥n', 'Cancelados'],
                datasets: [{
                    data: [
                        datos.atendido,
                        datos.pendiente,
                        datos.en_atencion,
                        datos.cancelado
                    ],
                    backgroundColor: [
                        '#28a745',
                        '#ffc107',
                        '#17a2b8',
                        '#dc3545'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 8,
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });
    }
    
    /**
     * Crea el gr√°fico de turnos por categor√≠a
     */
    function crearGraficoCategorias(datos) {
        const ctx = document.getElementById('chartCategorias').getContext('2d');
        
        if (charts.categorias) {
            charts.categorias.destroy();
        }
        
        charts.categorias = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Adulto Mayor', 'Discapacidad', 'Embarazada', 'Regular'],
                datasets: [{
                    data: [
                        datos.adulto_mayor,
                        datos.discapacidad,
                        datos.embarazada,
                        datos.ninguna
                    ],
                    backgroundColor: [
                        '#6f42c1',
                        '#fd7e14',
                        '#e83e8c',
                        '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 8,
                            font: {
                                size: 11
                            }
                        }
                    }
                }
            }
        });
    }
    
    /**
     * Crea el gr√°fico de turnos por tipo de tr√°mite
     */
    function crearGraficoTramites(datos) {
        const ctx = document.getElementById('chartTramites').getContext('2d');
        
        if (charts.tramites) {
            charts.tramites.destroy();
        }
        
        const labels = Object.keys(datos);
        const values = Object.values(datos);
        
        charts.tramites = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'N√∫mero de Turnos',
                    data: values,
                    backgroundColor: '#007bff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
    
    /**
     * Crea la lista detallada de estados
     */
    function crearListaEstados(datos) {
        const lista = document.getElementById('listaEstados');
        lista.innerHTML = `
            <div class="stat-item">
                <span class="stat-label">‚úÖ Atendidos:</span>
                <span class="stat-value">${datos.atendido}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">‚è≥ Pendientes:</span>
                <span class="stat-value">${datos.pendiente}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">üîÑ En Atenci√≥n:</span>
                <span class="stat-value">${datos.en_atencion}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">‚ùå Cancelados:</span>
                <span class="stat-value">${datos.cancelado}</span>
            </div>
        `;
    }
    
    /**
     * Crea la lista detallada de categor√≠as
     */
    function crearListaCategorias(datos) {
        const lista = document.getElementById('listaCategorias');
        lista.innerHTML = `
            <div class="stat-item">
                <span class="stat-label">üë¥ Adulto Mayor:</span>
                <span class="stat-value">${datos.adulto_mayor}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">‚ôø Discapacidad:</span>
                <span class="stat-value">${datos.discapacidad}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">ü§∞ Embarazada:</span>
                <span class="stat-value">${datos.embarazada}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">üë§ Regular:</span>
                <span class="stat-value">${datos.ninguna}</span>
            </div>
        `;
    }
    
    /**
     * Crea la lista detallada de tr√°mites
     */
    function crearListaTramites(datos) {
        const lista = document.getElementById('listaTramites');
        let html = '';
        
        for (const [tramite, cantidad] of Object.entries(datos)) {
            html += `
                <div class="stat-item">
                    <span class="stat-label">üìã ${tramite}:</span>
                    <span class="stat-value">${cantidad}</span>
                </div>
            `;
        }
        
        lista.innerHTML = html;
    }
    
    /**
     * Exporta las estad√≠sticas a PDF con gr√°ficos
     */
    async function exportarPDF() {
        if (!datosEstadisticas) {
            alert('No hay datos para exportar. Por favor, realice una consulta primero.');
            return;
        }
        
        try {
            // Mostrar indicador de carga
            const btnExportar = event.target;
            const textoOriginal = btnExportar.textContent;
            btnExportar.textContent = '‚è≥ Generando PDF...';
            btnExportar.disabled = true;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // T√≠tulo
            doc.setFontSize(18);
            doc.setTextColor(0, 123, 255);
            doc.text('Estad√≠sticas de Atenci√≥n', 105, 15, { align: 'center' });
            
            // Fecha del reporte
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 105, 22, { align: 'center' });
            
            // Per√≠odo consultado
            const fechaInicio = document.getElementById('fechaInicio').value;
            const fechaFin = document.getElementById('fechaFin').value;
            doc.text(`Per√≠odo: ${fechaInicio} al ${fechaFin}`, 105, 27, { align: 'center' });
            
            // Resumen general
            doc.setFontSize(12);
            doc.setTextColor(0);
            doc.text('Resumen General', 20, 38);
            
            doc.setFontSize(10);
            let y = 45;
            doc.text(`Total de Turnos: ${datosEstadisticas.total_turnos}`, 25, y);
            doc.text(`Tiempo Promedio: ${datosEstadisticas.tiempo_promedio_atencion} min`, 120, y);
            y += 7;
            doc.text(`Atendidos: ${datosEstadisticas.turnos_por_estado.atendido}`, 25, y);
            doc.text(`En Atenci√≥n: ${datosEstadisticas.turnos_por_estado.en_atencion}`, 120, y);
            y += 7;
            doc.text(`Pendientes: ${datosEstadisticas.turnos_por_estado.pendiente}`, 25, y);
            doc.text(`Cancelados: ${datosEstadisticas.turnos_por_estado.cancelado}`, 120, y);
            
            y += 12;
            
            // Capturar gr√°fico de estados
            doc.setFontSize(12);
            doc.text('Turnos por Estado', 20, y);
            y += 5;
            
            const chartEstados = document.getElementById('chartEstados');
            if (chartEstados) {
                const canvasEstados = await html2canvas(chartEstados, {
                    backgroundColor: '#ffffff',
                    scale: 2
                });
                const imgEstados = canvasEstados.toDataURL('image/png');
                doc.addImage(imgEstados, 'PNG', 15, y, 80, 60);
            }
            
            // Capturar gr√°fico de categor√≠as
            doc.text('Turnos por Categor√≠a', 110, y);
            
            const chartCategorias = document.getElementById('chartCategorias');
            if (chartCategorias) {
                const canvasCategorias = await html2canvas(chartCategorias, {
                    backgroundColor: '#ffffff',
                    scale: 2
                });
                const imgCategorias = canvasCategorias.toDataURL('image/png');
                doc.addImage(imgCategorias, 'PNG', 105, y + 5, 80, 60);
            }
            
            y += 70;
            
            // Nueva p√°gina para gr√°fico de tr√°mites
            doc.addPage();
            y = 20;
            
            doc.setFontSize(12);
            doc.text('Turnos por Tipo de Tr√°mite', 20, y);
            y += 5;
            
            const chartTramites = document.getElementById('chartTramites');
            if (chartTramites) {
                const canvasTramites = await html2canvas(chartTramites, {
                    backgroundColor: '#ffffff',
                    scale: 2
                });
                const imgTramites = canvasTramites.toDataURL('image/png');
                doc.addImage(imgTramites, 'PNG', 15, y, 180, 80);
            }
            
            y += 90;
            
            // Lista de tr√°mites
            doc.setFontSize(10);
            const tramites = datosEstadisticas.turnos_por_tramite;
            for (const [tramite, cantidad] of Object.entries(tramites)) {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(`${tramite}: ${cantidad}`, 20, y);
                y += 6;
            }
            
            // Guardar PDF
            doc.save(`estadisticas_${fechaInicio}_${fechaFin}.pdf`);
            
            // Restaurar bot√≥n
            btnExportar.textContent = textoOriginal;
            btnExportar.disabled = false;
            
        } catch (error) {
            console.error('Error al generar PDF:', error);
            alert('Error al generar el PDF: ' + error.message);
            event.target.disabled = false;
            event.target.textContent = 'üìÑ Exportar a PDF';
        }
    }
    
    /**
     * Exporta las estad√≠sticas a Excel (funcionalidad b√°sica)
     */
    function exportarExcel() {
        if (!datosEstadisticas) {
            alert('No hay datos para exportar. Por favor, realice una consulta primero.');
            return;
        }
        
        // Crear contenido CSV
        let csv = 'Estad√≠sticas de Atenci√≥n\n\n';
        
        // Per√≠odo
        const fechaInicio = document.getElementById('fechaInicio').value;
        const fechaFin = document.getElementById('fechaFin').value;
        csv += `Per√≠odo,${fechaInicio} al ${fechaFin}\n\n`;
        
        // Resumen General
        csv += 'Resumen General\n';
        csv += `Total de Turnos,${datosEstadisticas.total_turnos}\n`;
        csv += `Atendidos,${datosEstadisticas.turnos_por_estado.atendido}\n`;
        csv += `Pendientes,${datosEstadisticas.turnos_por_estado.pendiente}\n`;
        csv += `En Atenci√≥n,${datosEstadisticas.turnos_por_estado.en_atencion}\n`;
        csv += `Cancelados,${datosEstadisticas.turnos_por_estado.cancelado}\n`;
        csv += `Tiempo Promedio (min),${datosEstadisticas.tiempo_promedio_atencion}\n\n`;
        
        // Categor√≠as
        csv += 'Turnos por Categor√≠a\n';
        csv += `Adulto Mayor,${datosEstadisticas.turnos_por_categoria.adulto_mayor}\n`;
        csv += `Discapacidad,${datosEstadisticas.turnos_por_categoria.discapacidad}\n`;
        csv += `Embarazada,${datosEstadisticas.turnos_por_categoria.embarazada}\n`;
        csv += `Regular,${datosEstadisticas.turnos_por_categoria.ninguna}\n\n`;
        
        // Tr√°mites
        csv += 'Turnos por Tipo de Tr√°mite\n';
        for (const [tramite, cantidad] of Object.entries(datosEstadisticas.turnos_por_tramite)) {
            csv += `${tramite},${cantidad}\n`;
        }
        
        // Crear y descargar archivo
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `estadisticas_${fechaInicio}_${fechaFin}.csv`;
        link.click();
    }
</script>
</div> <!-- Cierre de main-content-with-sidebar -->
{% endblock %}
